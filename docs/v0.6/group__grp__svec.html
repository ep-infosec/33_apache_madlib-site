<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>MADlib: Sparse Vectors</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script src="../mathjax/MathJax.js">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">MADlib
   &#160;<span id="projectnumber">0.6</span> <span style="font-size:10pt; font-style:italic"><a href="../latest/./group__grp__svec.html"> A newer version is available</a></span>
   </div>
   <div id="projectbrief">User Documentation</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('group__grp__svec.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Sparse Vectors</div>  </div>
<div class="ingroups"><a class="el" href="group__grp__support.html">Support Modules</a></div></div>
<div class="contents">
<div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="closed.png" alt="+"/> Collaboration diagram for Sparse Vectors:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<center><table><tr><td><div class="center"><iframe scrolling="no" frameborder="0" src="group__grp__svec.svg" width="307" height="40"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</td></tr></table></center>
</div>
<dl class="user"><dt><b>About:</b></dt><dd></dd></dl>
<p>This module implements a sparse vector data type named "svec", which gives compressed storage of sparse vectors with many duplicate elements.</p>
<p>When we use arrays of floating point numbers for various calculations, we will sometimes have long runs of zeros (or some other default value). This is common in applications like scientific computing, retail optimization, and text processing. Each floating point number takes 8 bytes of storage in memory and/or disk, so saving those zeros is often worthwhile. There are also many computations that can benefit from skipping over the zeros.</p>
<p>To focus the discussion, consider, for example, the following array of doubles stored as a Postgres/GP "float8[]" data type:</p>
<div class="fragment"><pre class="fragment"><span class="stringliteral">&#39;{0, 33,...40,000 zeros..., 12, 22 }&#39;</span>::float8[].
</pre></div><p>This array would occupy slightly more than 320KB of memory/disk, most of it zeros. Even if we were to exploit the null bitmap and store the zeros as nulls, we would still end up with a 5KB null bitmap, which is still not nearly as memory efficient as we'd like. Also, as we perform various operations on the array, we'll often be doing work on 40,000 fields that would turn out not to be important.</p>
<p>To solve the problems associated with the processing of sparse vectors discussed above, we adopt a simple Run Length Encoding (RLE) scheme to represent sparse vectors as pairs of count-value arrays. So, for example, the array above would be represented as follows</p>
<div class="fragment"><pre class="fragment"><span class="stringliteral">&#39;{1,1,40000,1,1}:{0,33,0,12,22}&#39;</span>::MADlib.svec,
</pre></div><p>which says there is 1 occurrence of 0, followed by 1 occurrence of 33, followed by 40,000 occurrences of 0, etc. In contrast to the naive representations, we only need 5 integers and 5 floating point numbers to store the array. Further, it is easy to implement vector operations that can take advantage of the RLE representation to make computations faster. The module provides a library of such functions.</p>
<p>The current version only supports sparse vectors of float8 values. Future versions will support other base types.</p>
<dl class="user"><dt><b>Usage:</b></dt><dd></dd></dl>
<p>SVEC's can be constructed directly as follows: </p>
<pre>
	SELECT '{n1,n2,...,nk}:{v1,v2,...vk}'::MADlib.svec;
	</pre><p> WHERE <code>n1,n2,...,nk</code> specifies the counts for the values <code>v1,v2,...,vk</code>.</p>
<p>Or, SVEC's can also be casted from a float array: </p>
<pre>
	SELECT ('{v1,v2,...vk}'::float[])::MADlib.svec;
	</pre><p>Syntax reference can be found in <a class="el" href="svec_8sql__in.html" title="SQL type definitions and functions for sparse vector data type svec">svec.sql_in</a>.</p>
<p>Users need to add MADlib to their search_path to use the svec operators defined in the module.</p>
<dl class="user"><dt><b>Examples:</b></dt><dd></dd></dl>
<p>We can use operations with svec type like &lt;, &gt;, *, **, /, =, +, SUM, etc, and they have meanings associated with typical vector operations. For example, the plus (+) operator adds each of the terms of two vectors having the same dimension together. </p>
<div class="fragment"><pre class="fragment">sql&gt; SELECT (<span class="stringliteral">&#39;{0,1,5}&#39;</span>::float8[]::MADlib.svec + <span class="stringliteral">&#39;{4,3,2}&#39;</span>::float8[]::MADlib.svec)::float8[];
 float8  
---------
 {4,4,7}
</pre></div><p>Without the casting into float8[] at the end, we get: </p>
<div class="fragment"><pre class="fragment">sql&gt; SELECT <span class="stringliteral">&#39;{0,1,5}&#39;</span>::float8[]::MADlib.svec + <span class="stringliteral">&#39;{4,3,2}&#39;</span>::float8[]::MADlib.svec;
 ?column?  
----------
{2,1}:{4,7}             
</pre></div><p>A dot product (%*%) between the two vectors will result in a scalar result of type float8. The dot product should be (0*4 + 1*3 + 5*2) = 13, like this: </p>
<div class="fragment"><pre class="fragment">sql&gt; SELECT <span class="stringliteral">&#39;{0,1,5}&#39;</span>::float8[]::MADlib.svec %*% <span class="stringliteral">&#39;{4,3,2}&#39;</span>::float8[]::MADlib.svec;
 ?column? 
----------
    13
</pre></div><p>Special vector aggregate functions are also available. SUM is self explanatory. SVEC_COUNT_NONZERO evaluates the count of non-zero terms in each column found in a set of n-dimensional svecs and returns an svec with the counts. For instance, if we have the vectors {0,1,5}, {10,0,3},{0,0,3},{0,1,0}, then executing the SVEC_COUNT_NONZERO() aggregate function would result in {1,2,3}:</p>
<div class="fragment"><pre class="fragment">sql&gt; create table list (a MADlib.svec);
sql&gt; insert into list values (<span class="stringliteral">&#39;{0,1,5}&#39;</span>::float8[]), (<span class="stringliteral">&#39;{10,0,3}&#39;</span>::float8[]), (<span class="stringliteral">&#39;{0,0,3}&#39;</span>::float8[]),(<span class="stringliteral">&#39;{0,1,0}&#39;</span>::float8[]);

sql&gt; SELECT MADlib.svec_count_nonzero(a)::float8[] FROM list;
<a class="code" href="svec_8sql__in.html#abebdcbe45de346aff874db008e842e65">svec_count_nonzero</a> 
-----------------
    {1,2,3}
</pre></div><p>We do not use null bitmaps in the svec data type. A null value in an svec is represented explicitly as an NVP (No Value Present) value. For example, we have: </p>
<div class="fragment"><pre class="fragment">sql&gt; SELECT <span class="stringliteral">&#39;{1,2,3}:{4,null,5}&#39;</span>::MADlib.svec;
      svec        
-------------------
 {1,2,3}:{4,NVP,5}

sql&gt; SELECT <span class="stringliteral">&#39;{1,2,3}:{4,null,5}&#39;</span>::MADlib.svec + <span class="stringliteral">&#39;{2,2,2}:{8,9,10}&#39;</span>::MADlib.svec; 
         ?column?         
 --------------------------
  {1,2,1,2}:{12,NVP,14,15}
</pre></div><p>An element of an svec can be accessed using the <a class="el" href="svec_8sql__in.html#a8787222aec691f94d9808d1369aa401c">svec_proj()</a> function, which takes an svec and the index of the element desired. </p>
<div class="fragment"><pre class="fragment">sql&gt; SELECT MADlib.svec_proj(<span class="stringliteral">&#39;{1,2,3}:{4,5,6}&#39;</span>::MADlib.svec, 1) + MADlib.svec_proj(<span class="stringliteral">&#39;{4,5,6}:{1,2,3}&#39;</span>::MADlib.svec, 15);     
 ?column? 
----------
    7
</pre></div><p>A subvector of an svec can be accessed using the <a class="el" href="svec_8sql__in.html#a5cb3446de5fc117befe88ccb1ebb0e4e">svec_subvec()</a> function, which takes an svec and the start and end index of the subvector desired. </p>
<div class="fragment"><pre class="fragment">sql&gt; SELECT MADlib.svec_subvec(<span class="stringliteral">&#39;{2,4,6}:{1,3,5}&#39;</span>::MADlib.svec, 2, 11);
   <a class="code" href="svec_8sql__in.html#a5cb3446de5fc117befe88ccb1ebb0e4e">svec_subvec</a>   
----------------- 
 {1,4,5}:{1,3,5}
</pre></div><p>The elements/subvector of an svec can be changed using the function <a class="el" href="svec_8sql__in.html#a59407764a1cbf1937da39cf39a2f447c">svec_change()</a>. It takes three arguments: an m-dimensional svec sv1, a start index j, and an n-dimensional svec sv2 such that j + n - 1 &lt;= m, and returns an svec like sv1 but with the subvector sv1[j:j+n-1] replaced by sv2. An example follows: </p>
<div class="fragment"><pre class="fragment">sql&gt; SELECT MADlib.svec_change(<span class="stringliteral">&#39;{1,2,3}:{4,5,6}&#39;</span>::MADlib.svec,3,<span class="stringliteral">&#39;{2}:{3}&#39;</span>::MADlib.svec);
     <a class="code" href="svec_8sql__in.html#a59407764a1cbf1937da39cf39a2f447c">svec_change</a>     
---------------------
 {1,1,2,2}:{4,5,3,6}
</pre></div><p>There are also higher-order functions for processing svecs. For example, the following is the corresponding function for lapply() in R. </p>
<div class="fragment"><pre class="fragment">sql&gt; SELECT MADlib.svec_lapply(<span class="stringliteral">&#39;sqrt&#39;</span>, <span class="stringliteral">&#39;{1,2,3}:{4,5,6}&#39;</span>::MADlib.svec);
                  <a class="code" href="svec_8sql__in.html#a0d94c44dde95a00e3d802dee6d7c01eb">svec_lapply</a>                  
-----------------------------------------------
 {1,2,3}:{2,2.23606797749979,2.44948974278318}
</pre></div><p>The full list of functions available for operating on svecs are available in svec.sql.</p>
<p><b> A More Extensive Example</b></p>
<p>For a text classification example, let's assume we have a dictionary composed of words in a sorted text array: </p>
<div class="fragment"><pre class="fragment">sql&gt; create table features (a text[]);
sql&gt; insert into features values 
            (<span class="stringliteral">&#39;{am,before,being,bothered,corpus,document,i,in,is,me,</span>
<span class="stringliteral">               never,now,one,really,second,the,third,this,until}&#39;</span>);
</pre></div><p> We have a set of documents, each represented as an array of words: </p>
<div class="fragment"><pre class="fragment">sql&gt; create table documents(a <span class="keywordtype">int</span>,b text[]);
sql&gt; insert into documents values
            (1,<span class="stringliteral">&#39;{this,is,one,document,in,the,corpus}&#39;</span>),
            (2,<span class="stringliteral">&#39;{i,am,the,second,document,in,the,corpus}&#39;</span>),
            (3,<span class="stringliteral">&#39;{being,third,never,really,bothered,me,until,now}&#39;</span>),
            (4,<span class="stringliteral">&#39;{the,document,before,me,is,the,third,document}&#39;</span>);
</pre></div><p>Now we have a dictionary and some documents, we would like to do some document categorization using vector arithmetic on word counts and proportions of dictionary words in each document.</p>
<p>To start this process, we'll need to find the dictionary words in each document. We'll prepare what is called a Sparse Feature Vector or SFV for each document. An SFV is a vector of dimension N, where N is the number of dictionary words, and in each cell of an SFV is a count of each dictionary word in the document.</p>
<p>Inside the sparse vector library, we have a function that will create an SFV from a document, so we can just do this: </p>
<div class="fragment"><pre class="fragment">sql&gt; SELECT MADlib.svec_sfv((SELECT a FROM features LIMIT 1),b)::float8[] 
         FROM documents;

                <a class="code" href="svec_8sql__in.html#a375acd521ed9cb05f63b3696dcc10bf4">svec_sfv</a>
-----------------------------------------
 {0,0,0,0,1,1,0,1,1,0,0,0,1,0,0,1,0,1,0}
 {0,0,1,1,0,0,0,0,0,1,1,1,0,1,0,0,1,0,1}
 {1,0,0,0,1,1,1,1,0,0,0,0,0,0,1,2,0,0,0}
 {0,1,0,0,0,2,0,0,1,1,0,0,0,0,0,2,1,0,0}
</pre></div><p> Note that the output of MADlib.svec_sfv() is an svec for each document containing the count of each of the dictionary words in the ordinal positions of the dictionary. This can more easily be understood by lining up the feature vector and text like this: </p>
<div class="fragment"><pre class="fragment">sql&gt; SELECT MADlib.svec_sfv((SELECT a FROM features LIMIT 1),b)::float8[]
                , b 
         FROM documents;

                <a class="code" href="svec_8sql__in.html#a375acd521ed9cb05f63b3696dcc10bf4">svec_sfv</a>                 |                        b                         
-----------------------------------------+--------------------------------------------------
 {1,0,0,0,1,1,1,1,0,0,0,0,0,0,1,2,0,0,0} | {i,am,the,second,document,in,the,corpus}
 {0,1,0,0,0,2,0,0,1,1,0,0,0,0,0,2,1,0,0} | {the,document,before,me,is,the,third,document}
 {0,0,0,0,1,1,0,1,1,0,0,0,1,0,0,1,0,1,0} | {<span class="keyword">this</span>,is,one,document,in,the,corpus}
 {0,0,1,1,0,0,0,0,0,1,1,1,0,1,0,0,1,0,1} | {being,third,never,really,bothered,me,until,now}

sql&gt; SELECT * FROM features;
                                                a                                                    
--------------------------------------------------------------------------------------------------------
{am,before,being,bothered,corpus,document,i,in,is,me,never,now,one,really,second,the,third,<span class="keyword">this</span>,until}
</pre></div><p>Now when we look at the document "i am the second document in the corpus", its SFV is {1,3*0,1,1,1,1,6*0,1,2}. The word "am" is the first ordinate in the dictionary and there is 1 instance of it in the SFV. The word "before" has no instances in the document, so its value is "0" and so on.</p>
<p>The function MADlib.svec_sfv() can process large numbers of documents into their SFVs in parallel at high speed.</p>
<p>The rest of the categorization process is all vector math. The actual count is hardly ever used. Instead, it's turned into a weight. The most common weight is called tf/idf for Term Frequency / Inverse Document Frequency. The calculation for a given term in a given document is </p>
<div class="fragment"><pre class="fragment">{#Times in document} * log {#Documents / #Documents the term appears in}.
</pre></div><p> For instance, the term "document" in document A would have weight 1 * log (4/3). In document D, it would have weight 2 * log (4/3). Terms that appear in every document would have tf/idf weight 0, since log (4/4) = log(1) = 0. (Our example has no term like that.) That usually sends a lot of values to 0.</p>
<p>For this part of the processing, we'll need to have a sparse vector of the dictionary dimension (19) with the values </p>
<div class="fragment"><pre class="fragment">log(#documents/#Documents each term appears in). 
</pre></div><p> There will be one such vector for the whole list of documents (aka the "corpus"). The #documents is just a count of all of the documents, in this case 4, but there is one divisor for each dictionary word and its value is the count of all the times that word appears in the document. This single vector for the whole corpus can then be scalar product multiplied by each document SFV to produce the Term Frequency/Inverse Document Frequency weights.</p>
<p>This can be done as follows: </p>
<div class="fragment"><pre class="fragment">sql&gt; create table corpus as 
            (SELECT a, MADlib.svec_sfv((SELECT a FROM features LIMIT 1),b) sfv 
         FROM documents);
sql&gt; create table weights as
          (SELECT a docnum, MADlib.svec_mult(sfv, logidf) tf_idf 
           FROM (SELECT MADlib.svec_log(MADlib.svec_div(count(sfv)::MADlib.svec,MADlib.svec_count_nonzero(sfv))) logidf 
                FROM corpus) foo, corpus ORDER BYdocnum);
sql&gt; SELECT * FROM weights;

docnum |                tf_idf                                     
-------+----------------------------------------------------------------------
     1 | {4,1,1,1,2,3,1,2,1,1,1,1}:{0,0.69,0.28,0,0.69,0,1.38,0,0.28,0,1.38,0}
     2 | {1,3,1,1,1,1,6,1,1,3}:{1.38,0,0.69,0.28,1.38,0.69,0,1.38,0.57,0}
     3 | {2,2,5,1,2,1,1,2,1,1,1}:{0,1.38,0,0.69,1.38,0,1.38,0,0.69,0,1.38}
     4 | {1,1,3,1,2,2,5,1,1,2}:{0,1.38,0,0.57,0,0.69,0,0.57,0.69,0}
</pre></div><p>We can now get the "angular distance" between one document and the rest of the documents using the ACOS of the dot product of the document vectors: The following calculates the angular distance between the first document and each of the other documents: </p>
<div class="fragment"><pre class="fragment">sql&gt; SELECT docnum,
                180. * ( ACOS( MADlib.svec_dmin( 1., MADlib.svec_dot(tf_idf, testdoc) 
                    / (MADlib.svec_l2norm(tf_idf)*MADlib.svec_l2norm(testdoc))))/3.141592654) angular_distance 
         FROM weights,(SELECT tf_idf testdoc FROM weights WHERE docnum = 1 LIMIT 1) foo 
         ORDER BY 1;

docnum | angular_distance 
--------+------------------
     1 |                0
     2 | 78.8235846096986
     3 | 89.9999999882484
     4 | 80.0232034288617
</pre></div><p> We can see that the angular distance between document 1 and itself is 0 degrees and between document 1 and 3 is 90 degrees because they share no features at all. The angular distance can now be plugged into machine learning algorithms that rely on a distance measure between data points.</p>
<p>SVEC also provides functionality for declaring array given and array of positions and array of values, intermediate values betweens those are declared to be base value that user provides in the same function call. In the example below the fist array of integers represents the positions for the array two (array of floats). Positions do not need to come in the sorted order. Third value represents desired maximum size of the array. This assures that array is of that size even if last position is not. If max size &lt; 1 that value is ignored and array will end at the last position in the position vector. Final value is a float representing the base value to be used between the declared ones (0 would be a common candidate): </p>
<div class="fragment"><pre class="fragment">sql&gt; SELECT MADlib.svec_cast_positions_float8arr(ARRAY[1,2,7,5,87],ARRAY[.1,.2,.7,.5,.87],90,0.0);

        <a class="code" href="svec_8sql__in.html#a0ee423729fbca5abd46c86fa81d51f23">svec_cast_positions_float8arr</a>            
-----------------------------------------------------
{1,1,2,1,1,1,79,1,3}:{0.1,0.2,0,0.5,0,0.7,0,0.87,0}
(1 row)
</pre></div><p>Other examples of svecs usage can be found in the k-means module.</p>
<dl class="see"><dt><b>See also:</b></dt><dd>File <a class="el" href="svec_8sql__in.html" title="SQL type definitions and functions for sparse vector data type svec">svec.sql_in</a> documenting the SQL functions. </dd></dl>
</div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


    <li class="footer">Generated on Tue Apr 2 2013 14:57:03 for MADlib by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
